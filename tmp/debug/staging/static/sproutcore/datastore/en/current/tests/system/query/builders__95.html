<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=8" />
    <meta http-equiv="Content-Script-Type" content="text/javascript" />
    <title>Sproutcore Datastore</title>
  <script type="text/javascript">
/* >>>>>>>>>> BEGIN source/core.js */
// ==========================================================================
// Project:   SproutCore - JavaScript Application Framework
// Copyright: ©2006-2009 Sprout Systems, Inc. and contributors.
//            Portions ©2008-2009 Apple Inc. All rights reserved.
// License:   Licened under MIT license (see license.js)
// ==========================================================================

; if ((typeof SC !== 'undefined') && SC && SC.scriptDidLoad) SC.scriptDidLoad('sproutcore/bootstrap');
/* >>>>>>>>>> BEGIN source/system/browser.js */
// ==========================================================================
// Project:   SproutCore - JavaScript Application Framework
// Copyright: ©2006-2009 Sprout Systems, Inc. and contributors.
//            Portions ©2008-2009 Apple Inc. All rights reserved.
// License:   Licened under MIT license (see license.js)
// ==========================================================================

var SC = SC || { BUNDLE_INFO: {}, LAZY_INSTANTIATION: {} };

SC.browser = (function() {
  var userAgent = navigator.userAgent.toLowerCase();
  var version = (userAgent.match( /.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/ ) || [])[1] ;

  var browser = {
    version: version,
    safari: (/webkit/).test( userAgent ) ? version : 0,
    opera: (/opera/).test( userAgent ) ? version : 0,
    msie: (/msie/).test( userAgent ) && !(/opera/).test( userAgent ) ? version : 0,
    mozilla: (/mozilla/).test( userAgent ) && !(/(compatible|webkit)/).test( userAgent ) ? version : 0,
    mobileSafari: (/apple.*mobile.*safari/).test(userAgent) ? version : 0,
    windows: !!(/(windows)/).test(userAgent),
    mac: !!((/(macintosh)/).test(userAgent) || (/(mac os x)/).test(userAgent)),
    language: (navigator.language || navigator.browserLanguage).split('-', 1)[0]
  };
  
    browser.current = browser.msie ? 'msie' : browser.mozilla ? 'mozilla' : browser.safari ? 'safari' : browser.opera ? 'opera' : 'unknown' ;
  return browser ;
})();
; if ((typeof SC !== 'undefined') && SC && SC.scriptDidLoad) SC.scriptDidLoad('sproutcore/bootstrap');
/* >>>>>>>>>> BEGIN source/system/loader.js */
// ==========================================================================
// Project:   SproutCore - JavaScript Application Framework
// Copyright: ©2006-2009 Sprout Systems, Inc. and contributors.
//            Portions ©2008-2009 Apple Inc. All rights reserved.
// License:   Licened under MIT license (see license.js)
// ==========================================================================

SC.bundleDidLoad = function(bundle) {
  var info = this.BUNDLE_INFO[bundle] ;
  if (!info) info = this.BUNDLE_INFO[bundle] = {} ;
  info.loaded = true ;
};

SC.bundleIsLoaded = function(bundle) {
  var info = this.BUNDLE_INFO[bundle] ;
  return info ? !!info.loaded : false ;
};

SC.loadBundle = function() { throw "SC.loadBundle(): SproutCore is not loaded."; };

SC.setupBodyClassNames = function() {
  var el = document.body ;
  if (!el) return ;
  var browser, platform, shadows, borderRad, classNames, style;
  browser = SC.browser.current ;
  platform = SC.browser.windows ? 'windows' : SC.browser.mac ? 'mac' : 'other-platform' ;
  style = document.documentElement.style;
  shadows = (style.MozBoxShadow !== undefined) || 
                (style.webkitBoxShadow !== undefined) ||
                (style.oBoxShadow !== undefined) ||
                (style.boxShadow !== undefined);
  
  borderRad = (style.MozBorderRadius !== undefined) || 
              (style.webkitBorderRadius !== undefined) ||
              (style.oBorderRadius !== undefined) ||
              (style.borderRadius !== undefined);
  
  classNames = el.className ? el.className.split(' ') : [] ;
  if(shadows) classNames.push('box-shadow');
  if(borderRad) classNames.push('border-rad');
  classNames.push(browser) ;
  classNames.push(platform) ;
  if (SC.browser.mobileSafari) classNames.push('mobile-safari') ;
  el.className = classNames.join(' ') ;
} ;
; if ((typeof SC !== 'undefined') && SC && SC.scriptDidLoad) SC.scriptDidLoad('sproutcore/bootstrap');
/* >>>>>>>>>> BEGIN bundle_loaded.js */
; if ((typeof SC !== 'undefined') && SC && SC.bundleDidLoad) SC.bundleDidLoad('sproutcore/bootstrap');

</script>

     <link href="/static/sproutcore/testing/en/current/stylesheet.css?1257446874" rel="stylesheet" type="text/css" />
   
    
  </head>
    
  <body class="sc-theme focus" style="overflow:hidden;" >  
<script type="text/javascript">
// ==========================================================================
// Project:   SproutCore - JavaScript Application Framework
// Copyright: ©2006-2009 Sprout Systems, Inc. and contributors.
//            Portions ©2008-2009 Apple Inc. All rights reserved.
// License:   Licened under MIT license (see license.js)
// ==========================================================================

// sc_resource('setup_body_class_names'); // publish into inline format

if (SC.setupBodyClassNames) SC.setupBodyClassNames() ;
; if ((typeof SC !== 'undefined') && SC && SC.scriptDidLoad) SC.scriptDidLoad('sproutcore/bootstrap');
</script>


  <script type="text/javascript" src="/static/sproutcore/debug/en/current/source/core.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/debug/en/current/bundle_loaded.js?0"></script>
  <script type="text/javascript" src="/static/sproutcore/testing/en/current/source/core.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/testing/en/current/source/utils.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/testing/en/current/source/extras.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/testing/en/current/source/jquery.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/testing/en/current/source/qunit.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/testing/en/current/source/system/dump.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/testing/en/current/source/system/equiv.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/testing/en/current/source/system/plan.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/testing/en/current/source/system/runner.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/testing/en/current/source/system/suite.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/testing/en/current/bundle_loaded.js?0"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/license.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/core.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/debug/test_suites/array/base.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/debug/test_suites/array/indexOf.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/debug/test_suites/array/insertAt.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/debug/test_suites/array/objectAt.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/debug/test_suites/array/popObject.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/debug/test_suites/array/pushObject.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/debug/test_suites/array/rangeObserver.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/debug/test_suites/array/removeAt.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/debug/test_suites/array/removeObject.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/debug/test_suites/array/replace.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/debug/test_suites/array/shiftObject.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/debug/test_suites/array/unshiftObject.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/private/observer_set.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/mixins/observable.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/system/enumerator.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/mixins/enumerable.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/system/range_observer.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/mixins/array.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/mixins/comparable.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/mixins/copyable.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/mixins/delegate_support.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/mixins/freezable.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/system/set.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/system/object.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/private/chain_observer.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/private/observer_queue.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/protocols/observable_protocol.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/protocols/sparse_array_delegate.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/system/binding.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/system/error.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/system/index_set.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/system/logger.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/system/run_loop.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/system/selection_set.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/source/system/sparse_array.js?1257446874"></script>
  <script type="text/javascript" src="/static/sproutcore/runtime/en/current/bundle_loaded.js?0"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/core.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/data_sources/data_source.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/data_sources/cascade.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/models/record.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/data_sources/fixtures.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/debug/json.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/debug/standard_setup.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/fixtures/author_fixtures.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/fixtures/sample.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/models/record_attribute.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/models/fetched_attribute.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/models/many_attribute.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/models/single_attribute.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/system/many_array.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/system/store.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/system/nested_store.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/system/query.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/source/system/record_array.js?1257446873"></script>
  <script type="text/javascript" src="/static/sproutcore/datastore/en/current/bundle_loaded.js?0"></script>
<script type="text/javascript">String.preferredLanguage = "en";</script>
<script type="text/javascript">
if (typeof SC !== "undefined") {
  SC.mode = "TEST_MODE";
  SC.filename = "static/sproutcore/datastore/en/current/tests/system/query/builders.js"; 
}
(function() {
// ==========================================================================
// Project:   SproutCore - JavaScript Application Framework
// Copyright: ©2006-2009 Apple Inc. and contributors.
// License:   Licened under MIT license (see license.js)
// ==========================================================================
/*globals module ok equals same test MyApp */

// This file tests the initial state of the store when it is first created
// either independently or as a chained store.

// ..........................................................
// UTILITIES
// 

var TestRecord = SC.Record.extend();
var TestRecord2 = SC.Record.extend();

function queryEquals(q, location, recordType, conditions, extra, desc) {
  if (desc===undefined && typeof extra === 'string') {
    desc = extra;  extra = undefined ;
  }
  if (!desc) desc = '';
  
  ok(!!q, desc + ': should have a query');
  equals(q.get('isFrozen'), YES, desc + ": should be frozen");
  
  if (q) {
    if (location) {
      equals(q.get('location'), location, desc + ": should have location");
    }
    
    if (recordType && recordType.isEnumerable) {
      same(q.get('recordTypes'), recordType, desc + ': should have recordTypes (plural)');
    } else {
      equals(q.get('recordType'), recordType, desc + ': should have recordType (singular)');
    }
    
    equals(q.get('conditions'), conditions, desc + ': should have conditions');
        
    if (extra) {
      for (var key in extra) {
        if (!extra.hasOwnProperty(key)) continue;
        equals(q.get(key), extra[key], desc + ': should have extra key ' + key);
      }
    }
  }
} 

// ..........................................................
// BASIC TESTS
// 

// The local() and remote() builder methods are very similar.  This will 
// perform the same basic tests on both of them.  If you add a builder for a
// new type of location, you can just call this function again with your new
// location
function performBasicTests(methodName, loc) {

  module("SC.Query.%@()".fmt(methodName), {
    setup: function() {
      window.TestRecord = TestRecord;
      window.TestRecord2 = TestRecord2;
    },

    teardown: function() {
      window.TestRecord = window.TestRecord2 = null; // cleanup
    }
  });

  function invokeWith() {
    return SC.Query[methodName].apply(SC.Query, arguments);
  }
  
  test("basic query with just record type", function() {
    var q, q1, q2, q3, q4;

    // local
    q = invokeWith(TestRecord);
    queryEquals(q, loc, TestRecord, null, 'first query');

    q1 = invokeWith(TestRecord);
    equals(q1, q, 'second call should return cached value');

    // using string for record type name should work
    q2 = invokeWith("TestRecord");
    equals(q2, q, 'queryFor with string should return cached value');

    // using an array of a single item should be treated as a single item
    q3 = invokeWith([TestRecord]);
    equals(q3, q, 'queryFor([TestRecord]) should return cached value');

    // ditto w/ strings
    q4 = invokeWith(['TestRecord']);
    equals(q4, q, 'queryFor(["TestRecord"]) with string should return cached value');

  });
  
  test("query with multiple recordtypes", function() {

    var types = [TestRecord, TestRecord2],
        q1, q2, a3, q4, q5, set;

    // create first query
    q1 = invokeWith(types);
    queryEquals(q1, loc, types, null, 'first query');

    // try again - should get cache
    q2 = invokeWith(types);
    equals(q2, q1, 'second queryFor call should return cached value');

    // try again - different order
    q3 = invokeWith([TestRecord2, TestRecord]);
    equals(q3, q1, 'queryFor with different order of record types should return same cached value');

    // try again - using a set
    set = SC.Set.create().add(TestRecord).add(TestRecord2);
    q4  = invokeWith(set);
    equals(q4, q1, 'should return cached query even if using an enumerable for types');

    // try again using strings
    q5 = invokeWith('TestRecord TestRecord2'.w());
    equals(q5, q1, 'should return cached query even if string record names are used');
  });
  
  test("query with record type and conditions", function() {

    var q1, q2, q3, q4, q5, q6, q7;
    
    q1 = invokeWith(TestRecord, 'foobar');
    queryEquals(q1, loc, TestRecord, 'foobar', 'first query');

    q2 = invokeWith(TestRecord, 'foobar');
    equals(q2, q1, 'second call to queryFor(TestRecord, foobar) should return cached instance');

    q3 = invokeWith(TestRecord2, 'foobar');
    queryEquals(q3, loc, TestRecord2, 'foobar', 'query(TestRecord2, foobar)');
    ok(q3 !== q1, 'different recordType same conditions should return new query');

    q4 = invokeWith(TestRecord, 'baz');
    queryEquals(q4, loc, TestRecord, 'baz', 'query(TestRecord2, baz)');
    ok(q4 !== q1, 'different conditions should return new query');

    q5 = invokeWith(TestRecord, 'baz');
    equals(q5, q4, 'second call for different conditions should return cache');
  });
  
  test("query with no record type and with conditions", function() {
    var q1, q2;

    q1 = invokeWith(null, 'foobar');
    queryEquals(q1, loc, SC.Record, 'foobar', 'first query');

    q2 = invokeWith(null, 'foobar');
    equals(q2, q1, 'should return cached value');
  });

  test("query with recordtype, conditions, and parameters hash", function() {
    var opts  = { opt1: 'bar', opt2: 'baz' },
        q1, q2;

    q1 = invokeWith(TestRecord, 'foo', opts);
    queryEquals(q1, loc, TestRecord, 'foo', { parameters: opts }, 'first query');

    q2 = invokeWith(TestRecord, 'foo', opts);
    ok(q1 !== q2, 'second call to queryFor with opts cannot be cached');
    queryEquals(q1, loc, TestRecord, 'foo', { parameters: opts }, 'second query');
  });

  test("query with recordtype, conditions, and parameters array", function() {
    var opts  = ['foo', 'bar'],
        q1, q2;

    q1 = invokeWith(TestRecord, 'foo', opts);
    queryEquals(q1, loc, TestRecord, 'foo', { parameters: opts }, 'first query should include parameters prop');

    q2 = invokeWith(TestRecord, 'foo', opts);
    ok(q1 !== q2, 'second call to queryFor with opts cannot be cached');
    queryEquals(q1, loc, TestRecord, 'foo', { parameters: opts }, 'second query');
  });

  test("passing query object", function() {

    var local = SC.Query.local(TestRecord),
        remote = SC.Query.remote(TestRecord),
        q;
        
    q = invokeWith(local);
    if (loc === SC.Query.LOCAL) {
      equals(q, local, 'invoking with local query should return same query');
    } else {
      ok(q !== local, 'invoke with local query should return new instance');
    }    
    equals(q.get('location'), loc, 'query should have expected location');

    q = invokeWith(remote);
    if (loc === SC.Query.REMOTE) {
      equals(q, remote, 'invoking with remote query should return same query');
    } else {
      ok(q !== remote, 'invoke with remote query should return new instance');
    }    
    equals(q.get('location'), loc, 'query should have expected location');
  });
  
  test("no options (matches everything)", function() {
    var q1, q2;
    
    q1 = invokeWith(); 
    queryEquals(q1, loc, SC.Record, null, 'first query - matches everything');

    q2 = invokeWith();
    equals(q2, q1, 'should return same cached query');

  });

  
}

performBasicTests('local', SC.Query.LOCAL);
performBasicTests('remote', SC.Query.REMOTE);

})();
</script>
	</body>
</html>
